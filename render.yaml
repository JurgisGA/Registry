#########################################################
# render.yaml â€“ Dynamic Registry Builder (Render IaaC)  #
#########################################################

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. Web & Static services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
services:
  # â”€â”€ Laravel API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - type: web
    name: registry-api
    env: php              # ğŸ‘ˆ  use â€œenv: phpâ€
    plan: free

    buildCommand: |
      composer install --prefer-dist --no-dev -q -o
      php artisan key:generate --force
      php artisan migrate --force

    startCommand: php artisan serve --host 0.0.0.0 --port $PORT

    envVars:
      - key: APP_ENV
        value: production

      # generate a random APP_KEY the first time
      - key: APP_KEY
        generateValue: true

      # add the connection string from the database declared below
      - key: DATABASE_URL
        fromDatabase:
          name: registry-db
          property: connectionString

  # â”€â”€ Vue + Vuetify SPA (static site) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - type: web
    name: registry-ui
    env: static           # ğŸ‘ˆ  â€œenv: staticâ€ for static sites
    plan: free

    buildCommand: |
      cd ui
      pnpm install
      pnpm run build

    staticPublishPath: ui/dist

    envVars:
      - key: VITE_API_BASE_URL
        value: https://registry-api.onrender.com  # update if API name changes

    # SPA fallback so all unknown routes serve index.html
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. PostgreSQL database â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
databases:
  - name: registry-db
    databaseName: registry      # Render may suffix this automatically
    plan: free
    ipAllowList: []             # empty list = allow internal services
